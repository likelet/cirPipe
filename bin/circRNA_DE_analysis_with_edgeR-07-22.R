# R script for Differential expression analysis 

# required package 
requre.packages <- c("data.table","dplyr","ggplot2","edger")
for(i in 1:length()){
  library(requre.packages[i])
}




#' Run differential expression analysis with circPipe 
#' 
#' \code{DifferentialExressionAnalysis} run DifferentialExressionAnalysis
#' @author Ye Zi
#' @description differential expression analysis from design matrix and compare file in circpipe
#' 
#' 
#' @param expres.mat.filePath  epression matrix generated by circpipe
#' @param design.filePath A design matrix for compare 
#' @param compare.filePath A compare file  path that contains the compare string inside. e.g. A_vs_B
#' @param annotation.filePath annotation file path generated by circpipetools
#' @param p_value P value threshold to help determine the  differential expressed circRNAs from EdgeR result 
#' @param fc Foldchange threshold to determine the differential expressed circRNAs
#' @param expres.freq  filter circRNAs with expression frequncy.  default 4

#' @return none

#' 
#' @export 

DifferentialExressionAnalysis<- function(expres.mat.filePath, design.filePath, compare.filePath, annotation.filePath, OutputBaseName, p_value= 0.05 , fc = 1.5,expres.freq = 4){
  # pre functions 
  parse_comparedata<-function(compare.filePath){
    compare.str = as.vector(read.table(compare.filePath))
    type_level <- rev(strsplit((compare.str[1,1]),split = "_vs_")[[1]])#type_level <- levels(colData$Type)
    comb <- combn(type_level,2)
    return(comb)
  }
  lfc <- log2(fc)  #logFC
  comb <- parse_comparedata(compare.filePath)

  ###output file names
  output.circRNA_RPM.mat <- paste0(OutputBaseName,"/circRNAs_RPM.mat")
  output.DE_result <-  paste0(OutputBaseName,"/",comb[2,1], "_vs_", comb[1,1],"_DE.edgeR.xls")
  output.plot <- paste0(OutputBaseName,"/",comb[2,1], "_vs_", comb[1,1], "_DE.plot.edgeR.pdf")
  #sort colData by group info
    design.mat = as.data.frame(fread(design.filePath))%>%
      arrange(Type) 
    colData = data.frame(Type = factor(design.mat$Type,levels = type_level),row.names = design.mat$Sample_id)

  #load expression matrix and sort its colnames by design matrix
    expres.mat = as.data.frame(fread(expres.mat.filePath,sep = "\t"))
    colnames(expres.mat)[1]="id"
    expres.mat = dplyr::select(expres.mat,id,design.mat$Sample_id)
    countData = as.matrix(expres.mat[,-1])
    rownames(countData) = expres.mat$id
    #filter circRNAs with expression frequncy
    countData <- countData[which(rowSums(countData > 0 ) >= expres.freq),] # CircRNA expressed in at least 2 samples
    #in case too few sample
      if (length(design.mat$Sample_id) < 4 ){
        print("too few samples")
        quit()
      }

    # run 
      Circ_edgeR.res <-edgeR_test(expre_mat = countData,group_mat = colData,design_mode = "paired")
      Circ_edgeR.res$id = rownames(Circ_edgeR.res)
      Circ_edgeR.res.anno = mutate(Circ_edgeR.res,
                                  expres_regu = case_when(logFC >= lfc & FDR <= p_value ~ "up_regulation",
                                                          logFC <= -lfc & FDR <= p_value ~ "down_regulation",
                                                          TRUE ~ "NotSig."))#%>%inner_join(annotation.df)

        
      DE_Circ.res = filter(Circ_edgeR.res.anno,FDR <= p_value & abs(logFC) >= lfc)%>%
        arrange(desc(logFC))
      DE_list = as.character(DE_Circ.res$id)
      Circ_norm.mat=cpm(countData)
      DE_Circ_norm.mat=Circ_norm.mat[DE_list,]

      ####output table
      write.table(Circ_norm.mat,file = output.circRNA_RPM.mat,sep = "\t",row.names = TRUE,quote = FALSE)
      write.table(Circ_edgeR.res.anno,file = output.DE_result,sep = "\t",row.names = FALSE,quote = FALSE)

      if (length(DE_list) >= 2) {

      pdf(file = output.plot)
      # Vocano plot
      # rename colname to match the function designed for DESeq2 result
      colnames(Circ_edgeR.res) = gsub("logFC","log2FoldChange",colnames(Circ_edgeR.res))
      colnames(Circ_edgeR.res) = gsub("FDR","padj",colnames(Circ_edgeR.res))
      print(volcano.plot(DE_res.df = Circ_edgeR.res,p_value = p_value,fc = fc )  )

      #heatmap
      #width=458&height=464
      heatmap_house(Circ_norm.mat[DE_list,],colData,title_hp = "Heatmap of Different expressed circRNA")
      heatmap_house(Circ_norm.mat[DE_list,],colData,
                    title_hp = "Heatmap of Different expressed circRNA",cluster_rule = "col")
      #####PCA
      PCA_plot(DE_list,Circ_norm.mat[DE_list,],colData)
      dev.off()
      } else {
        print("differnt expression circRNA < 2 ; cannot plot and enrichment analysis !")
      }
}

# run function ####################

# parse parameters 

args <-commandArgs(T)
function.script <- args[1] = "./R_function.R" 
expres.mat.filePath <- args[2] 
design.filePath <- args[3]  
compare.filePath <- args[4]  
annotation.filePath <- args[5] 

OutputBaseName <- args[6] 



#source function script
source(function.script)
# Main function 
DifferentialExressionAnalysis(expres.mat.filePath, design.filePath, compare.filePath, annotation.filePath, OutputBaseName)